@page "/loan_management"
@inject ILoanService LoanService

<PageTitle>Loan Management</PageTitle>

<h4>Current Loans</h4>
<!-- Search and Filter Loans -->
<div>
    <input type="text" @bind="searchTerm" placeholder="Search by Member or Book ID..." />
    <button @onclick="SearchLoans">Search</button>
</div>

<!-- Loans Table -->
@if (loanResults != null && loanResults.Count > 0)
{
    <table class="table">
        <thead>
            <tr>
                <th>Book Title</th>
                <th>Member Name</th>
                <th>Checkout Date</th>
                <th>Due Date</th>
                <th>Return Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var loan in loanResults.Skip((currentPage - 1) * pageSize).Take(pageSize))
            {
                <tr>
                    <td>@loan.BookTitle</td>
                    <td>@loan.MemberName</td>
                    <td>@loan.CheckoutDate.ToShortDateString()</td>
                    <td>@loan.DueDate.ToShortDateString()</td>
                    <td>@loan.ReturnDate?.ToShortDateString()</td>
                    <td>
                        @if (loan.ReturnDate == null) // Check if the ReturnDate is null
                        {<button class="btn btn-primary" @onclick="() => ReturnLoan(loan)">Return</button>}
                    </td>
                </tr>
            }
        </tbody>
    </table>
    @if (loanResults.Count > pageSize)
    {
    <div>
        <button class="btn btn-link" disabled="@IsFirstPage()" @onclick="PrevPage">Previous</button>
        <button class="btn btn-link" disabled="@IsLastPage()" @onclick="NextPage">Next</button>
    </div>
    }
}
else
{
    <p>No loans found.</p>
}

<h4>Add New Loan</h4>
<EditForm Model="@newLoan" OnValidSubmit="AddLoan">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div class="form-group">
        <label for="bookId">Book ID:</label>
        <InputNumber id="bookId" class="form-control" @bind-Value="newLoan.BookId" />
    </div>
    <div class="form-group">
        <label for="memberId">Member ID:</label>
        <InputNumber id="memberId" class="form-control" @bind-Value="newLoan.MemberId" />
    </div>
    <div class="form-group">
        <label for="dueDate">Due Date:</label>
        <InputDate id="dueDate" class="form-control" @bind-Value="newLoan.DueDate" />
    </div>
    <button type="submit" class="btn btn-primary">Add Loan</button>
</EditForm>

@code {
    private Loan newLoan = new Loan();
    private List<Loan> loanResults = new List<Loan>();
    private string searchTerm;
    private string validationMessage;
    private int currentPage = 1;
    private int pageSize = 5; 

    protected override async Task OnInitializedAsync()
    {
        await FetchLoans();
    }
    private async Task FetchLoans()
    {
        try
        {
            var loans = await LoanService.GetLoansAsync();
            loanResults = loans.ToList();
        }
        catch (Exception ex)
        {
            validationMessage = $"Error fetching books: {ex.Message}";
        }
    }

    // Pagination helpers
    private bool IsFirstPage() => currentPage == 1;
    private bool IsLastPage() => (currentPage * pageSize) >= loanResults.Count;
    private void PrevPage()
    {
        if (!IsFirstPage())
            currentPage--;
    }
    private void NextPage()
    {
        if (!IsLastPage())
            currentPage++;
    }
    private async Task AddLoan()
    {
        await LoanService.AddLoan(newLoan);
        newLoan = new Loan(); // Reset the form
        await FetchLoans();
    }
    private async Task ReturnLoan(Loan returnLoan)
    {
        await LoanService.ReturnLoan(returnLoan);
    }

    private async Task SearchLoans()
    {
        // Implement search logic based on the searchTerm, similar to your member search
        // Reset states as needed
    }

}
