@page "/loan_management"
@inject ILoanService LoanService

<PageTitle>Loan Management</PageTitle>

<h4>Current Loans</h4>
<!-- Search and Filter Loans -->
<div>
    <input type="text" @bind="searchTerm" placeholder="Search by Member Email or Book Title..." />
    <button @onclick="SearchLoans">Search</button>
    <span> @searchResults.Count results </span>
</div>

<!-- Loans Table -->
@if (searchResults != null && searchResults.Count > 0)
{
    <table class="table">
        <thead>
            <tr>
                <th>Book Title</th>
                <th>Member Name</th>
                <th>Checkout Date</th>
                <th>Due Date</th>
                <th>Return Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var loan in searchResults.Skip((currentPage - 1) * pageSize).Take(pageSize))
            {
                <tr>
                    <td>@loan.BookTitle</td>
                    <td>@loan.MemberName</td>
                    <td>@loan.CheckoutDate.ToShortDateString()</td>
                    <td>@loan.DueDate.ToShortDateString()</td>
                    <td>@loan.ReturnDate?.ToShortDateString()</td>
                    <td>
                        @if (loan.ReturnDate == null) // Check if the ReturnDate is null
                        {<button class="btn btn-primary" @onclick="() => ReturnLoan(loan)">Return</button>}
                    </td>
                </tr>
            }
        </tbody>
    </table>
    @if (searchResults.Count > pageSize)
    {
    <div>
        <button class="btn btn-link" disabled="@IsFirstPage()" @onclick="PrevPage">Previous</button>
        <button class="btn btn-link" disabled="@IsLastPage()" @onclick="NextPage">Next</button>
    </div>
    }
}
else
{
    <p>No loans found.</p>
}

<h4>Add New Loan</h4>
<EditForm Model="@newLoan" OnValidSubmit="AddLoan">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div class="form-group">
        <label for="bookISBN">Book ISBN:</label>
        <InputText id="bookISBN" class="form-control" @bind-Value="newLoan.BookISBN" />
    </div>
    <div class="form-group">
        <label for="memberEmail">Member Email:</label>
        <InputText id="memberEmail" class="form-control" @bind-Value="newLoan.MemberEmail" />
    </div>
    <div class="form-group mt-3">
        <button type="submit" class="btn btn-primary">Add Loan</button>
    </div>
</EditForm>
    @if (!string.IsNullOrEmpty(validationMessage))
    {
        <div class="alert alert-danger">@validationMessage</div>
    }
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success">@successMessage</div>
    }

@code {
    private Loan newLoan = new Loan();
    private List<Loan> searchResults = new List<Loan>();
    private string searchTerm;
    private string validationMessage;
    private string successMessage;
    private int currentPage = 1;
    private int pageSize = 8; 

    protected override async Task OnInitializedAsync()
    {
        await FetchLoans();
    }
    private async Task FetchLoans()
    {
        try
        {
            var loans = await LoanService.GetLoansAsync();
            searchResults = loans.ToList();
        }
        catch (Exception ex)
        {
            validationMessage = $"Error fetching books: {ex.Message}";
            Console.WriteLine(validationMessage);
        }
    }

    // Pagination helpers
    private bool IsFirstPage() => currentPage == 1;
    private bool IsLastPage() => (currentPage * pageSize) >= searchResults.Count;
    private void PrevPage()
    {
        if (!IsFirstPage())
            currentPage--;
    }
    private void NextPage()
    {
        if (!IsLastPage())
            currentPage++;
    }
    private async Task AddLoan()
    {
        try
        {
            await LoanService.AddLoan(newLoan);
            newLoan = new Loan(); // Reset the form
            await FetchLoans();
            successMessage = "Loan added successfully.";
        }
        catch (Exception ex)
        {
            validationMessage = "Failed to add loan: " + ex.Message;
        }
        StateHasChanged(); // Ensure UI update
        await Task.Delay(3000);
        ClearMessages();
    }
    private async Task ReturnLoan(Loan returnLoan)
    {
        await LoanService.ReturnLoan(returnLoan);
    }

    private async Task SearchLoans()
    {
        try
        {
            var loans = await LoanService.GetLoansAsync();
            if (string.IsNullOrWhiteSpace(searchTerm))
            {
                searchResults = loans.ToList();
            }
            else
            {
                searchResults = loans.Where(b => b.BookTitle.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
                                                    || b.MemberName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
                                                    || b.MemberEmail.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
                                                    || b.BookISBN.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();
            }
            validationMessage = "";
        }
        catch (Exception ex)
        {
            validationMessage = "Search failed: " + ex.Message;
        }
    }

    private void ClearMessages()
    {
        validationMessage = string.Empty;
        successMessage = string.Empty;
    }

}
